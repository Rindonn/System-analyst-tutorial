第三章-操作系统基本原理

操作系统概述

主要功能

处理机管理

存储器管理

设备管理

文件管理

用户接口

操作系统的类型

单用户操作系统

一台处理机只能支持一个用户程序的运行，系统的全部资源都提供给该用户使用

批处理系统

作业成批装入计算机中，由操作系统在计算机的输入并将其组织好，按一定算法选择其中的一个或多个作业，将其调入内存并运行。运行结束后将结果放入磁盘输出井，由计算机统一输出后交给用户

分时操作系统

把CPU时间的时间划分为很短的时间片，轮流分配给各个终端作业使用

网络操作系统

在计算机网络环境下，具有网络功能的操作系统

分布式操作系统

是由多台计算机组成的系统，系统中若干个计算机可以相互合作，共同完成同一个任务

优点是各节点的自治性好，资源共享的透明性强，各节点具有协同性

缺点是系统状态不明确，控制机构复杂、通信开销会引起性能的下降

嵌入式操作系统

运行在嵌入式智能芯片环境，对整个智能芯片和它的操作、控制的各种部件装置等资源进行统一协调、处理、指挥和控制

特点是及时性、支持多道程序设计，高可靠性和较强的过载保护能力

操作系统的结构

整体结构

主要设计思想和步骤

把模块作为操作系统的基本单位，按照功能将整个系统分解为若干个模块，每个模块具有一定的独立功能，若干个关联模块协作完成某个功能；明确各个模块之间的接口关系，各个模块之间可以不加控制的自由调用，模块之间需要传递参数或返回结果时，其个数和方式也可以根据需要随意约定

分别设计、编码、调试各个模块

将所有模块连结成一个完整的系统

主要优点

结构紧密、组合方便，对不同环境和用户的不同需求，可以组合不同模块来予以满足，灵活性大

针对某个功能可用最有效的算法和任意调用其他模块中的过程来实现，系统效率高

由于划分成模块和子模块，设计及编码可齐头并进，加快系统研制过程

主要缺点

模块独立性差

模块之间牵连甚多

系统结构不清晰

正确性难保证

可靠性降低

系统功能增删改十分困难

层次结构

将操作系统分为内核和若干模块，这些模块按功能的调用次序排列成若干层次，各层之间只能是单向依赖或调用关系，高层可以调用低层的功能，反之不行

主要优点

系统接口要少且简单

系统的正确性大大提高

增加、修改或替换一个层次不会影响其他层次，有利于系统的维护和扩展

主要缺点

必须建立模块间的通信机制

系统花费在通信上的开销较大

系统的效率有所降低

客户/服务器结构

微内核

将传统的操作系统代码放置到更高层，从操作系统中去掉尽可能多的东西，只留下一个最小的核心，称为微内核

为了获取某项服务，用户进程将请求发送给一个服务器进程，服务器金正完成此操作后，把结果返回用户进程，这样服务器以用户进程的形式运行，而不是运行在核心态

主要优点

某个服务器的崩溃不会导致整个系统的崩溃

更适用于分布式系统

接口统一

可伸缩性好

可移植性好

实时性好

安全可靠性高

面向对象结构

面向对象操作系统中的对象是操作系统管理的信息和资源的抽象，可以被视为受保护的信息或资源的总称，它拥有自己的状态和存储空间，且其状态只能由事先定义好的操作来改变，而改变这些对象状态的操作状态只能由事先定义好的操作来改变，而改变这些对象的状态又需要其他的对象发送相应消息后才能被启动，因此容易采用某种手段对其对象实施保护

进程管理

进程是进行资源分配和调度的基本单位

进程的状态

三态模型

运行态

阻塞态

就绪态

五态模型

运行态

活跃就绪

静止就绪

活跃阻塞

静止阻塞

信号量与pv操作

信号量

信号量是一个二元组(S,Q)，S是一个初值非负的整型变量，Q是一个初始状态为空的等待队列

PV操作是对信号量进行处理的过程，且只能由PV操作改变，P操作使信号量-1，V操作使信号量+1，分别记为P(S)，V(S)

互斥模型

为临界资源设置一个信号量S，初值为1，必须成对使用PV操作

同步模型

设置一个同步信号量S，一个进程使用P操作时，另一个进程使用V操作

死锁问题

概念

当若干个进程竞争使用资源时，如果每个进程都占用一定资源，又申请使用已被另一个进程占用，不可被抢占的资源，则这些进程都进入阻塞状态们不能继续运行的现象，称为死锁

四个必要条件

互斥条件

不剥夺条件

请求与保持条件

环路条件

解决方法

死锁预防

破坏不剥夺条件

若申请新资源无法被满足，则暂时释放已有资源

破坏请求与保持条件

进程一次申请全部资源，只要有一个不被满足则不分配任何资源

破坏环路条件

进程按资源号有序申请

死锁避免

将限制条件弱化，允许死锁的存在，又不让其发生，设置一种安全状态，进程按某种顺序分配资源。在某一时刻系统能为每个进程分配资源，直到最大需求，使每个进程顺利完成。此时系统为安全状态，否则为不安全状态

银行家算法

银行家把资金借给若干顾客，使这些顾客都能满足需求且又能完成交易，银行家也可以回收全部现金。只要不出现一个顾客借走所有资金后还不够，则银行家的资金就是安全的

死锁的检测和解除

系统保存资源的请求和分配信息，利用某种算法对信息进行检查，判断是否有死锁存在。

恢复方法

资源剥夺

进程撤销

进程回退

线程管理

线程是进程的活动成分，是处理器分配资源的最小单位

线程的实现方式

内核线程

依赖系统内核的线程，由内核内部需求进行创建和撤销，一个线程发起系统调用而阻塞不会影响其他线程

用户线程

不依赖于操作系统内核，利用线程库创建、同步、调度、管理，无需在用户态和核心态切换。若某线程阻塞则整个进程需要等待。

轻权线程

操作系统内核支持的线程，每个轻权线程由一个单独的内核线程来支持

与进程相比

调度

线程是调度和分配的基本单位，进程是资源拥有的基本单位

并发性

都可以并发执行

拥有资源

线程除了必不可少的资源外不拥有系统资源，但是一个进程拥有的资源可以供所有它的线程共享

系统开销

进程切换涉及CPU环境的保存和新CPU的环境设置等，线程切换只需保存设置少量寄存器内容。

通信

进程间需要同步和互斥，线程间可以直接读写数据段

多线程模型

多对一模型

将多个用户线程映射到一个内核线程

运行效率比较高

但是如果一个线程执行了阻塞系统调用，那么整个进程都会阻塞，且多个线程不能并行运行在多处理器上

一对一模型

一个用户线程对应一个内核线程

并发性更好，允许多线程并行运行在多处理器

但是消耗更多系统资源

多对多模型

复用了许多用户线程到同样数量或更小数量的内核线程上

可以创建任意多的用户线程，并且能在多处理器上并行执行

而且当一个线程执行系统调用阻塞时，内核可以调度另一个线程来执行

内存管理

功能

内存空间的分配和回收

配合硬件进行地址转换，把用户的逻辑地址转换成处理器用的物理地址

使若干个进程可同时访问公共内存区，又不会相互干扰

使用外存缓解内存不足的问题

地址变换

原因

由于源程序不能被计算机直接执行，需要编译得到目标程序，目标程序的地址不是内存的实际地址，一般将用户目标程序使用的地址称为逻辑地址，逻辑地址从0开始编址。当程序运行时，会被装入内存，此时实际地址不同于原来的逻辑地址，就需要进行地址变换。

公式

物理地址=起始的物理地址+逻辑地址

静态重定位

在作业装入时由作业装入程序实现的地址转换，要求目标程序使用相对地址，在作业执行前完成。

特点是容易实现，无需添加地址变换硬件，但为每个程序分配连续的存储区，且执行时不能移动

动态重定位

在程序执行过程中，CPU访问程序和数据之前实现地址转换

特点是借助硬件实现，优点是程序可以在内存中移动

分区存储管理

固定分区

在作业装入之前，内存就被划分为若干个分区，划分完成后分区大小和个数均不可变，系统有一张分区说明表，每个表目说明一个分区的大小、起始地址和是否分配的标志。

主要优点是实现技术简单，适用于作业大小和多少事先清晰的系统

主要缺点是内存利用率低，内部碎片多

可变分区

在作业装入时，从可用内存划出一块连续的区域分配给它，形成一个新的分区，且分区大小正好等于作业大小。

可变分区在分配时，首先找到一个足够大的空闲分区，系统将空闲分区分成两部分每一部分分配出去，另一部分仍作为空闲区，回收空闲区时检查前后空闲区是否邻接并进行合并

可变分区分配策略

首次适应算法

从空闲表第一个表目起查找，把最先满足要求的空闲区分配给该作业。为适应该算法，空闲区表要从地址低到高排序。

目的在于减少查找时间，当空闲表中的小空闲区过多时，算法性能急剧下降

最佳适应算法

从全部空闲区中找出满足作业要求的最小空闲区。为适应该算法，空闲区表中的空闲区要按大小从小到大排序，从表头开始查找第一个满足要求的空闲区分配。

优点是碎片尽量小。分配空间时尽量利用低地址的存储区，有利于大进程空间的装入

最坏适应算法

从所有未分配分区中挑选最大的且大于等于作业大小的分区分给要求的作业，空闲区从大到小排序，每次从链头开始查找。

特点是过多的分割大空闲区，该算法对中小型作业有利

可重定位分区

基本思想是在适当的时候把零散的空闲区合并为一个大的空闲区，实现方式是移动某些已分配区域中的信息，使所有分配挨着存储器一段，空白区在另一端。

多重分区

基本思想是为作业分配一个或以上的分区，允许一个作业在运行过程中动态申请附加存储空间，该空间不必和已有作业分区连接

优点是便于使用共享子程序或数据

缺点是需要较多硬件支持

存储器保护

界地址保护

界限寄存器

下界寄存器存放作业分区的起始地址，上界寄存器存储下一个分区的起始地址，每次寻址和访问时，先与这两个寄存器内容比较，以实现对分区的保护

基址和限长寄存器

基址寄存器存放作业分区的起始地址，限长寄存器存放作业的最大偏移量，作业运行时在访问存储器时所计算的存储地址如果超过限长，则发出越界中断信号

设置存储键保护

基本思想是系统对每个作业或进程进行内存分配时，对同一作业的个页面对应的内存块都要指定一个相同的，不与其他作业相同的键，保存于快速寄存器和改作业的程序状态字中。当程序要访问某个块时，将程序状态字的键与被访问块的键进行比较，若相符则允许，否则越界中断。若键为0则不必进行比较工作

段页式存储管理

页式存储管理

系统为每个作业建立一张页面映射表，记录相应页在内存对应的页帧号。在分页存储管理时，地址结构由页号和页内位移组成。通过在系统中设置页表寄存器用来存放页表的起始地址和页表长度。进程未执行时，每个进程对应的页表起始地址和长度存放在进程的PCB中，当该进程被调度时就将其装入页表寄存器。

进行地址变换时，系统将页号与页表长度比较，若大于则越界，若未越界则计算出该页的物理块号，装入物理地址寄存器，同时将有效地址寄存器中的页内地址装入物理地址寄存器的块内地址字段，这样就完成了地址变换

若页表存放在内存中，每次访问时都要先访问内存中的页表，然后根据物理地址再访问内存，降低了处理速度。可以通过增设一个具有并行查询功能的特殊高速缓冲存储器，用以存放当前访问的页表项

段式存储管理

按用户作业中的自然段划分逻辑空间，每段占用连续的地址空间，逻辑地址是二维的，由段号和段内地址组成，系统为每个作业建立一张段表，记录该段在内存中的起始地址和段长，各段可以存放在内存不同的分区中，段的分配和回收与可变分区存储管理相同。

段式存储管理的地址地址变换采用动态重定位的方式，地址变换机构取出逻辑地址的段号和段内地址，根据段号检索段表，找到对应表目，将起始地址与段内地址相加得到绝对地址。

与页式存储的区别

分页是单一线性地址空间，分段作业地址是二维的

页是信息的物理单位，大小固定，分页活动是用户看不见的，分页的目的是提高内存利用率。段是信息的逻辑单位，长度不定，分段是用户可见的活动，分段是为了更好满足用户需要

分页存储管理实现单段式虚拟存储系统，而段式存储管理实现多段式虚拟存储系统

段页式存储管理

结合了分页和分段的存储管理方法，将作业分为若干段，每段分为若干页，每段一个有一个段名，为实现地址变换，每个作业分配一个段表和若干个页表，内存回收和分配以页为单位进行。作业的逻辑地址是二维的，有段号和段内地址，其中段内地址又包含页号和页内地址

地址转换时，先取出逻辑地址，并根据页大小将段内地址细分为页号和页内地址，根据段号检索段表，找到该段的页表存放地址，根据页号查页表，取出相应的页帧号，把页帧号和页内地址合并，得到物理地址，执行访存操作。

由于获得一条指令需要三次访问内存，使得系统执行指令的速度更慢，可以通过快表解决这个问题。快表中存放当前使用的段号、页号、页帧号和页内地址等表目。

虚拟存储管理

用处

解决作业全部装入后，某些部分执行一次后闲置的情况

解决方案

应用程序运行之前不必全部装入内存，仅装入所需部分，其余部分驻留外存，当请求外存内容时，操作系统请求调入。若内存已满则将内存中暂时不用的部分调到外存。这样就可以使一个大的用户程序运行在较小的内存空间。用户角度看可以发现该系统的内存容量比实际内存容量要大的多，因此将这种请求调入和置换功能，能从逻辑上对内存扩充的存储器系统称为虚拟存储系统

局部性原理

时间局部性

程序中某条指令一旦执行，不久后该指令可能再次执行。

原因是程序中存在着大量循环操作

空间局部性

程序一旦访问某个存储单元，不久之后附近存储单元也将被访问

原因是程序的顺序执行

工作集

抖动现象

频繁出现页面交换使得系统实际效率大幅降低

工作集是在某段时间内，进程要实际访问的页面集合，引入虚拟内存后，程序只需要少量内存就可运行，但为使程序有效运行，必须使程序的工作集全部在内存中

页面置换算法

是在页面置换的时候选择被访问概率最低的页的算法

随机淘汰算法

随机选择某个页面将其换出

轮转算法

按照内存页面编号，循环换出内存中一个被换出的页

先进先出算法

总是淘汰在内存中驻留最久的页

最近最久未使用算法

选择距离当前时间最近的一段时间内最久没有使用过的页淘汰

最近未使用页面置换算法

从最近一个时期内未被访问的页任选一个置换

最优置换算法

选择最长时间内不再被访问的页面置换出去，目前很难实现

时钟页面替换算法

将作业调入内存的页面链成循环队列，用一个指针指向循环队列中的下一个被置换页面，当一个页面首次装入内存后设置标志位x，每循环一次x-1，当x到0之后淘汰该页，指针继续推进

文件系统

文件的组织结构

逻辑结构

流式文件

流式文件是相关信息项的集合，基本单位是字节，适合基本信息单位操作不多的文件

记录式文件

记录式文件是数据记录的集合，基本单位是逻辑记录，逻辑组织有顺序存储方式、直接存储方式、按键存储方式三种

物理结构

物理结构是文件在存储介质上的组织方式，依赖于物理的存储设备和存储空间

顺序结构

逻辑上连续的记录构成的文件分配到连续的物理块中

链接结构

将信息存放在非连续的物理块中，每个物理块都有一个指针，指向后续的物理块，从而使存放同一文件的物理块连接成一个串联队列

链接结构空间利用率高，且易于文件扩充，但查找效率低

索引结构

为每个文件建立一个索引表，其中每个表项指出信息所在的物理块号，表目按逻辑记录编写顺序或按记录的某关键词顺序排列

可以满足文件的动态增长，存取方便，但建立索引表增加存储开销，且多级索引访问时间较长

树形文件结构

主文件目录称为根目录，根目录下的子目录称为中间节点，子目录下的文件称为叶节点，从根目录出发到某文件的通路上所有各级子目录名和该文件名的顺序组合称为文件的路径名，每个文件都有唯一的一个路径名

为操作方便，系统给用户指定一个当前目录，若用户想访问某文件，只需给出相对路径名即可。

特点是层次清楚，解决了文件重名问题，提高查找效率，且方便用户共享文件

存储空间管理

空闲文件目录

磁盘空间上一个连续的未分配区域称为空闲文件。系统为所有空闲文件单独建立一个目录。对每个空闲文件，在此目录建立一个表目，表目包含第一个空闲块地址和空闲块个数等信息。

分配存储空间时可以使用首次适应和最佳适应等算法，回收时，同样要进行空闲区的合并。优点是空闲区的分配和回收都很容易，但是维护空闲表占用大量存储空间

空闲块链

是将所有空闲块用链接指针或索引结构组成一个空闲文件。释放和分配空闲块都在链首进行，只需要修改几个有关的链接字。

优点是实现简单，但工作效率低

位示图

是利用二进制的1位表示文件存储空间中的1个块的使用情况。

分配存储空间时，顺序扫描位示图，找到一个或一组标志为0的二进制位分配出去并置1，回收存储空间时将该值清零即可。

适用于所有的分配方式，且简单易行，而且空间较小，通常读入内存。

成组链接法

是对空闲块链法的一种改进，将一个文件卷的所有空闲盘块按固定大小分成若干组，并将每一组的盘块数和该组所有的盘块记入前一组的最后一个盘块中，第一组的盘块数和该组所有盘块号计入超级块的空闲块中

当系统分配文件所需盘块时，若第一组不止一块，则超级块中空闲盘块数-1，并将栈顶的空闲块分配出去，若第一组只剩一块且栈顶的盘块号不是结束标记，则先将该块内容读到超级块中再分配出去，否则若栈顶盘块号为0，则表示磁盘没有空闲块。

除了第一组的空闲盘块外，其余空闲盘块的记录不占用额外的存储空间，因此绝大部分分配和回收工作在内存中进行，效率较高

分布式文件系统

分布式文件系统是分布式系统的重要组成部分，允许通过网络互联，使不同机器上的用户共享文件，

特点

网络透明性

用户访问文件服务器上的文件的操作如同访问本地文件系统一样

位置透明性

用户通过文件名访问文件，但不知道该文件在网络中的位置的话，只要文件名字不变，用户仍可访问到该文件

文件服务

文件系统为其用户提供的各种功能描述，提供了文件系统与用户的接口

文件服务器

文件服务器是运行在网络中某台机器上的一个实现文件服务的进程，一个系统可以有一个或多个文件服务器，单用户不知道多个服务器的位置和功能，只知道当调用文件服务中某个具体过程时，所要求的工作以某种方式执行并返回所要求的结果

组成

服务器DFS软件

客户机DFS软件

架构

客户/服务器架构

客户远程访问文件，服务器响应客户需求

命名的透明性

通过机器名+路径名访问文件

将远程文件系统安装在本机文件目录上

让所有机器上用相同的单一命名空间
